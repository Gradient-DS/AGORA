openapi: 3.0.0
info:
  title: AGORA HAI REST API
  version: 2.0.0
  description: |
    REST API for the AGORA Human Agent Interface (HAI).
    This API handles session management, conversation history retrieval, and other non-real-time operations
    that complement the AG-UI WebSocket protocol.

  contact:
    name: AGORA Development Team
    email: lex@gradient-ds.com

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  # ---------------------------------------------------------------------------
  # HEALTH & INFO
  # ---------------------------------------------------------------------------
  /health:
    get:
      summary: Health check endpoint
      description: Returns server health status.
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "agora-mock"
                  protocol:
                    type: string
                    example: "ag-ui"

  /:
    get:
      summary: Root endpoint with API information
      description: Returns API version and key endpoint paths.
      operationId: root
      tags:
        - Health
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "AGORA Orchestration"
                  version:
                    type: string
                    example: "2.0.0"
                  protocol:
                    type: string
                    example: "AG-UI Protocol v2.1.1"
                  docs:
                    type: string
                    description: Path to OpenAPI documentation
                    example: "/docs"
                  websocket:
                    type: string
                    description: WebSocket endpoint path
                    example: "/ws"

  /agents:
    get:
      summary: List available agents
      description: Returns the list of available agents in the system.
      operationId: listAgents
      tags:
        - Agents
      responses:
        '200':
          description: Agent list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentListResponse'

  # ---------------------------------------------------------------------------
  # SESSION MANAGEMENT
  # ---------------------------------------------------------------------------
  /sessions:
    get:
      summary: List sessions for a user
      description: |
        Retrieves all sessions for a specific user, ordered by last activity (most recent first).
        Used by the frontend to display the conversation history sidebar.
      operationId: listSessions
      tags:
        - Sessions
      parameters:
        - in: query
          name: user_id
          schema:
            type: string
            example: "koen"
          required: true
          description: Inspector persona ID (e.g., "koen", "fatima", "jan")
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of sessions to return
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: Session list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sessions/{session_id}:
    delete:
      summary: Delete a session
      description: |
        Deletes a session and all its associated data, including conversation history and metadata.
      operationId: deleteSession
      tags:
        - Sessions
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
            example: "123e4567-e89b-12d3-a456-426614174000"
          required: true
          description: Unique session identifier
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Session deleted"
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sessions/{session_id}/metadata:
    get:
      summary: Get session metadata
      description: |
        Retrieves metadata for a specific session without the full conversation history.
        Useful for displaying session info in the sidebar without loading all messages.
      operationId: getSessionMetadata
      tags:
        - Sessions
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
            example: "123e4567-e89b-12d3-a456-426614174000"
          required: true
          description: Unique session identifier
      responses:
        '200':
          description: Session metadata retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  session:
                    $ref: '#/components/schemas/SessionMetadata'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sessions/{session_id}/history:
    get:
      summary: Get conversation history
      description: |
        Retrieves the full conversation history for a specific session.
        This should be called by the client when switching sessions or on page load
        before establishing the WebSocket connection.
      operationId: getSessionHistory
      tags:
        - Sessions
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
            example: "123e4567-e89b-12d3-a456-426614174000"
          required: true
          description: Unique session identifier (same as threadId)
        - in: query
          name: include_tools
          schema:
            type: boolean
            default: false
          description: |
            If true, includes tool calls (role: "tool_call") and tool results (role: "tool") in the history.
            Required for restoring the debug panel state.
      responses:
        '200':
          description: Conversation history retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ---------------------------------------------------------------------------
  # USER MANAGEMENT
  # ---------------------------------------------------------------------------
  /users/me:
    get:
      summary: Get current user profile
      description: Retrieves profile information for the specified user.
      operationId: getCurrentUser
      tags:
        - Users
      parameters:
        - in: query
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Current user ID
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/preferences:
    get:
      summary: Get user preferences
      description: Retrieves the current user's preferences.
      operationId: getUserPreferences
      tags:
        - Users
      parameters:
        - in: query
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Current user ID
      responses:
        '200':
          description: Preferences retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  preferences:
                    $ref: '#/components/schemas/UserPreferences'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update user preferences
      description: Updates settings like spoken response mode.
      operationId: updateUserPreferences
      tags:
        - Users
      parameters:
        - in: query
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Current user ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePreferencesRequest'
      responses:
        '200':
          description: Preferences updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  preferences:
                    $ref: '#/components/schemas/UserPreferences'
        '400':
          description: Invalid input (e.g., invalid spoken_response_mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users:
    post:
      summary: Create a new user
      description: |
        Creates a new user account. Email must be unique across the system.
      operationId: createUser
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid input (e.g., missing required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict - email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: List all users
      description: |
        Retrieves a paginated list of all users, ordered by creation date (most recent first).
        Requires admin privileges.
      operationId: listUsers
      tags:
        - Users
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum number of users to return
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: User list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{user_id}:
    get:
      summary: Get user by ID
      description: Retrieves profile information for a specific user.
      operationId: getUser
      tags:
        - Users
      parameters:
        - in: path
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Unique user identifier
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/UserProfile'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update user
      description: Updates user profile information. Partial updates are supported via query parameters.
      operationId: updateUser
      tags:
        - Users
      parameters:
        - in: path
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Unique user identifier
        - in: query
          name: name
          schema:
            type: string
          description: User's display name
        - in: query
          name: role
          schema:
            type: string
            enum: [admin, inspector, viewer]
          description: User's role
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete user
      description: |
        Deletes a user and all associated data. This operation cascades to delete
        all sessions owned by the user, including their conversation history.
      operationId: deleteUser
      tags:
        - Users
      parameters:
        - in: path
          name: user_id
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
          required: true
          description: Unique user identifier
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User and associated sessions deleted"
                  deletedSessionsCount:
                    type: integer
                    description: Number of sessions that were deleted
                    example: 5
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ---------------------------------------------------------------------------
  # MOCK DOCUMENTS (for testing)
  # ---------------------------------------------------------------------------
  /mock_documents/{filename}:
    get:
      summary: Get mock document
      description: |
        Serves mock document files for testing (e.g., report.json, report.pdf).
        Only available in the mock server.
      operationId: getMockDocument
      tags:
        - Mock
      parameters:
        - in: path
          name: filename
          schema:
            type: string
            enum: ["report.json", "report.pdf"]
            example: "report.pdf"
          required: true
          description: Name of the mock document file
      responses:
        '200':
          description: Document retrieved successfully
          content:
            application/json:
              schema:
                type: object
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    # -------------------------------------------------------------------------
    # AGENT SCHEMAS
    # -------------------------------------------------------------------------
    Agent:
      type: object
      description: Agent information
      required: [id, name, model, description]
      properties:
        id:
          type: string
          description: Unique agent identifier
          example: "general-agent"
        name:
          type: string
          description: Human-readable agent name
          example: "Algemene Assistent"
        model:
          type: string
          description: LLM model used by the agent
          example: "gpt-4o"
        description:
          type: string
          description: Agent description (first paragraph of instructions)
          example: "Algemene vraag- en routeringagent"

    InactiveAgent:
      type: object
      description: Inactive/unavailable agent information
      required: [id, name, reason]
      properties:
        id:
          type: string
          description: Unique agent identifier
          example: "deprecated-agent"
        name:
          type: string
          description: Human-readable agent name
          example: "Deprecated Agent"
        reason:
          type: string
          description: Reason why the agent is inactive
          example: "Disabled for maintenance"

    AgentListResponse:
      type: object
      description: Response for listing agents
      required: [active_agents, inactive_agents]
      properties:
        active_agents:
          type: array
          description: List of currently active agents
          items:
            $ref: '#/components/schemas/Agent'
        inactive_agents:
          type: array
          description: List of inactive/unavailable agents
          items:
            $ref: '#/components/schemas/InactiveAgent'

    # -------------------------------------------------------------------------
    # SESSION SCHEMAS
    # -------------------------------------------------------------------------
    SessionMetadata:
      type: object
      description: Metadata for a conversation session
      required: [sessionId, userId, title, messageCount, createdAt, lastActivity]
      properties:
        sessionId:
          type: string
          description: Unique session identifier (same as threadId)
          example: "123e4567-e89b-12d3-a456-426614174000"
        userId:
          type: string
          description: Inspector persona ID
          example: "koen"
        title:
          type: string
          description: Auto-generated title from first message
          example: "Inspectie bij Restaurant Bella Rosa"
        firstMessagePreview:
          type: string
          description: Preview of the first message (truncated)
          example: "Start inspectie bij Restaurant..."
        messageCount:
          type: integer
          description: Total number of messages in the session
          example: 12
        createdAt:
          type: string
          format: date-time
          description: Session creation timestamp
          example: "2025-12-01T10:30:00Z"
        lastActivity:
          type: string
          format: date-time
          description: Last message timestamp
          example: "2025-12-01T11:45:00Z"

    SessionListResponse:
      type: object
      description: Response for listing sessions
      required: [success, sessions, totalCount]
      properties:
        success:
          type: boolean
          example: true
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/SessionMetadata'
        totalCount:
          type: integer
          description: Total number of sessions (for pagination)
          example: 42

    # -------------------------------------------------------------------------
    # HISTORY SCHEMAS
    # -------------------------------------------------------------------------
    HistoryResponse:
      type: object
      description: Response for conversation history
      required: [success, threadId, history, messageCount]
      properties:
        success:
          type: boolean
          example: true
        threadId:
          type: string
          description: Session/thread identifier
          example: "123e4567-e89b-12d3-a456-426614174000"
        history:
          type: array
          items:
            $ref: '#/components/schemas/HistoryMessage'
        messageCount:
          type: integer
          description: Number of messages in history
          example: 15

    HistoryMessage:
      type: object
      description: |
        A single message in the conversation history.
        The role field determines the message type and available fields.
      required: [role, content]
      properties:
        role:
          type: string
          enum: [user, assistant, tool_call, tool]
          description: |
            Message role:
            - user: User input
            - assistant: Agent response
            - tool_call: Tool invocation (when include_tools=true)
            - tool: Tool result (when include_tools=true)
        content:
          type: string
          description: |
            Message content. For tool_call, this is the JSON-encoded arguments.
            For tool, this is the tool result.
        agent_id:
          type: string
          description: Agent that produced this message (for assistant and tool_call roles)
          example: "history-agent"
        tool_call_id:
          type: string
          description: Tool call identifier (for tool_call and tool roles)
          example: "call-abc123"
        tool_name:
          type: string
          description: Name of the tool (for tool_call and tool roles)
          example: "get_company_info"
      example:
        role: "assistant"
        content: "Inspectie gestart voor Restaurant Bella Rosa..."
        agent_id: "history-agent"

    # Legacy schemas for backward compatibility
    UserMessage:
      type: object
      deprecated: true
      description: "Deprecated: Use HistoryMessage with role='user' instead"
      required: [role, content]
      properties:
        role:
          type: string
          const: "user"
        content:
          type: string

    AssistantMessage:
      type: object
      deprecated: true
      description: "Deprecated: Use HistoryMessage with role='assistant' instead"
      required: [role, content]
      properties:
        role:
          type: string
          const: "assistant"
        content:
          type: string
        agent_id:
          type: string

    ToolCallMessage:
      type: object
      description: Tool invocation message (only present when include_tools=true)
      required: [role, tool_call_id, tool_name, content]
      properties:
        role:
          type: string
          const: "tool_call"
        tool_call_id:
          type: string
          description: Unique tool call identifier
        tool_name:
          type: string
          description: Name of the tool being called
        content:
          type: string
          description: JSON-encoded tool arguments
        agent_id:
          type: string
          description: Agent that made this tool call

    ToolResultMessage:
      type: object
      description: Tool result message (only present when include_tools=true)
      required: [role, tool_call_id, tool_name, content]
      properties:
        role:
          type: string
          const: "tool"
        tool_call_id:
          type: string
          description: Tool call identifier this result belongs to
        tool_name:
          type: string
          description: Name of the tool
        content:
          type: string
          description: Tool execution result

    # -------------------------------------------------------------------------
    # USER SCHEMAS
    # -------------------------------------------------------------------------
    UserProfile:
      type: object
      description: Full user profile information
      required: [id, email, name, role, createdAt, lastActivity]
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          description: User's email address (unique)
          example: "jane.doe@example.com"
        name:
          type: string
          description: User's display name
          example: "Jane Doe"
        role:
          type: string
          enum: [admin, inspector, viewer]
          description: User's role in the system
          example: "inspector"
        preferences:
          $ref: '#/components/schemas/UserPreferences'
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2025-01-15T09:00:00Z"
        lastActivity:
          type: string
          format: date-time
          description: Last activity timestamp
          example: "2025-12-18T14:30:00Z"

    CreateUserRequest:
      type: object
      description: Request body for creating a new user
      required: [email, name]
      properties:
        email:
          type: string
          format: email
          description: User's email address (must be unique)
          example: "new.user@example.com"
        name:
          type: string
          description: User's display name
          example: "New User"
        role:
          type: string
          enum: [admin, inspector, viewer]
          default: inspector
          description: User's role in the system
          example: "inspector"

    UpdateUserRequest:
      type: object
      description: Request body for updating a user (all fields optional)
      properties:
        name:
          type: string
          description: User's display name
          example: "Updated Name"
        preferences:
          $ref: '#/components/schemas/UserPreferences'

    UserListResponse:
      type: object
      description: Response for listing users
      required: [success, users, totalCount]
      properties:
        success:
          type: boolean
          example: true
        users:
          type: array
          items:
            $ref: '#/components/schemas/UserProfile'
        totalCount:
          type: integer
          description: Total number of users (for pagination)
          example: 25

    UserPreferences:
      type: object
      description: User preferences stored in the system
      properties:
        theme:
          type: string
          enum: [light, dark, system]
          default: system
          description: UI theme preference
        notifications_enabled:
          type: boolean
          default: true
          description: Enable in-app notifications
        default_agent_id:
          type: string
          default: "general-agent"
          example: "general-agent"
          description: Default agent to use for new conversations
        language:
          type: string
          default: "nl-NL"
          example: "nl-NL"
          description: UI language preference
        spoken_text_type:
          type: string
          enum: [dictate, summarize]
          default: summarize
          description: |
            Type of spoken text for TTS:
            - dictate: Full text-to-speech of responses
            - summarize: Summarized spoken responses

    UpdatePreferencesRequest:
      type: object
      description: Request body for updating user preferences
      properties:
        theme:
          type: string
          enum: [light, dark, system]
          description: UI theme preference
        notifications_enabled:
          type: boolean
          description: Enable in-app notifications
        default_agent_id:
          type: string
          description: Default agent to use for new conversations
        language:
          type: string
          description: UI language preference
        spoken_text_type:
          type: string
          enum: [dictate, summarize]
          description: |
            Type of spoken text for TTS:
            - dictate: Full text-to-speech of responses
            - summarize: Summarized spoken responses

    # -------------------------------------------------------------------------
    # COMMON SCHEMAS
    # -------------------------------------------------------------------------
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error code or short type
          example: "not_found"
        message:
          type: string
          description: Human readable error message
          example: "The requested resource could not be found."

