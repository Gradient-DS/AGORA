asyncapi: 3.0.0
info:
  title: AGORA AG-UI Protocol API
  version: 2.0.0
  description: |
    WebSocket protocol for communication between the Human Agent Interface (HAI) 
    and the AGORA LangGraph orchestrator using the AG-UI Protocol.
    
    **Protocol:** AG-UI (Agent-User Interface Protocol)
    **Reference:** https://github.com/ag-ui-protocol/ag-ui
    
    ## Key Features
    - Event-driven streaming communication
    - Lifecycle events for run/step tracking
    - Text message streaming with START/CONTENT/END pattern
    - Tool call events with argument streaming
    - Custom events for human-in-the-loop approval
    
  contact:
    name: AGORA Development Team
    email: lex@gradient-ds.com

servers:
  development:
    host: localhost:8000
    protocol: ws
    description: Local development server

channels:
  /ws:
    address: /ws
    messages:
      RunAgentInput:
        $ref: '#/components/messages/RunAgentInput'
      RunStartedEvent:
        $ref: '#/components/messages/RunStartedEvent'
      RunFinishedEvent:
        $ref: '#/components/messages/RunFinishedEvent'
      StepStartedEvent:
        $ref: '#/components/messages/StepStartedEvent'
      StepFinishedEvent:
        $ref: '#/components/messages/StepFinishedEvent'
      TextMessageStartEvent:
        $ref: '#/components/messages/TextMessageStartEvent'
      TextMessageContentEvent:
        $ref: '#/components/messages/TextMessageContentEvent'
      TextMessageEndEvent:
        $ref: '#/components/messages/TextMessageEndEvent'
      ToolCallStartEvent:
        $ref: '#/components/messages/ToolCallStartEvent'
      ToolCallArgsEvent:
        $ref: '#/components/messages/ToolCallArgsEvent'
      ToolCallEndEvent:
        $ref: '#/components/messages/ToolCallEndEvent'
      CustomEvent:
        $ref: '#/components/messages/CustomEvent'

operations:
  sendInput:
    action: send
    channel:
      $ref: '#/channels/~1ws'
    summary: Send run input or custom events (approval response)
    messages:
      - $ref: '#/channels/~1ws/messages/RunAgentInput'
      - $ref: '#/channels/~1ws/messages/CustomEvent'
  
  receiveEvents:
    action: receive
    channel:
      $ref: '#/channels/~1ws'
    summary: Receive AG-UI events from server
    messages:
      - $ref: '#/channels/~1ws/messages/RunStartedEvent'
      - $ref: '#/channels/~1ws/messages/RunFinishedEvent'
      - $ref: '#/channels/~1ws/messages/StepStartedEvent'
      - $ref: '#/channels/~1ws/messages/StepFinishedEvent'
      - $ref: '#/channels/~1ws/messages/TextMessageStartEvent'
      - $ref: '#/channels/~1ws/messages/TextMessageContentEvent'
      - $ref: '#/channels/~1ws/messages/TextMessageEndEvent'
      - $ref: '#/channels/~1ws/messages/ToolCallStartEvent'
      - $ref: '#/channels/~1ws/messages/ToolCallArgsEvent'
      - $ref: '#/channels/~1ws/messages/ToolCallEndEvent'
      - $ref: '#/channels/~1ws/messages/CustomEvent'

components:
  messages:
    RunAgentInput:
      name: RunAgentInput
      title: Run Agent Input
      summary: Input to start a new agent run
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunAgentInput'
      examples:
        - name: BasicQuestion
          summary: User asks a question
          payload:
            threadId: "123e4567-e89b-12d3-a456-426614174000"
            runId: "run-abc123"
            userId: "550e8400-e29b-41d4-a716-446655440001"
            messages:
              - role: "user"
                content: "What are the food safety regulations for restaurants?"

    RunStartedEvent:
      name: RunStartedEvent
      title: Run Started
      summary: Emitted when an agent run begins
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunStartedEvent'
      examples:
        - name: RunStarted
          payload:
            type: "RUN_STARTED"
            threadId: "123e4567-e89b-12d3-a456-426614174000"
            runId: "run-abc123"
            timestamp: "2025-01-15T10:30:00Z"

    RunFinishedEvent:
      name: RunFinishedEvent
      title: Run Finished
      summary: Emitted when an agent run completes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RunFinishedEvent'
      examples:
        - name: RunFinished
          payload:
            type: "RUN_FINISHED"
            threadId: "123e4567-e89b-12d3-a456-426614174000"
            runId: "run-abc123"
            timestamp: "2025-01-15T10:30:05Z"

    StepStartedEvent:
      name: StepStartedEvent
      title: Step Started
      summary: Emitted when a processing step begins
      contentType: application/json
      payload:
        $ref: '#/components/schemas/StepStartedEvent'
      examples:
        - name: ThinkingStep
          payload:
            type: "STEP_STARTED"
            stepName: "thinking"
            metadata:
              message: "Analyzing your question..."
            timestamp: "2025-01-15T10:30:01Z"

    StepFinishedEvent:
      name: StepFinishedEvent
      title: Step Finished
      summary: Emitted when a processing step completes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/StepFinishedEvent'
      examples:
        - name: StepFinished
          payload:
            type: "STEP_FINISHED"
            stepName: "thinking"
            timestamp: "2025-01-15T10:30:02Z"

    TextMessageStartEvent:
      name: TextMessageStartEvent
      title: Text Message Start
      summary: Emitted when a text message begins streaming
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TextMessageStartEvent'
      examples:
        - name: AssistantMessageStart
          payload:
            type: "TEXT_MESSAGE_START"
            messageId: "msg-abc123"
            role: "assistant"
            timestamp: "2025-01-15T10:30:02Z"

    TextMessageContentEvent:
      name: TextMessageContentEvent
      title: Text Message Content
      summary: Emitted for each content chunk during streaming
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TextMessageContentEvent'
      examples:
        - name: ContentChunk
          payload:
            type: "TEXT_MESSAGE_CONTENT"
            messageId: "msg-abc123"
            delta: "Based on the regulations, "
            timestamp: "2025-01-15T10:30:02Z"

    TextMessageEndEvent:
      name: TextMessageEndEvent
      title: Text Message End
      summary: Emitted when a text message is complete
      contentType: application/json
      payload:
        $ref: '#/components/schemas/TextMessageEndEvent'
      examples:
        - name: MessageEnd
          payload:
            type: "TEXT_MESSAGE_END"
            messageId: "msg-abc123"
            timestamp: "2025-01-15T10:30:04Z"

    ToolCallStartEvent:
      name: ToolCallStartEvent
      title: Tool Call Start
      summary: Emitted when a tool call begins
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ToolCallStartEvent'
      examples:
        - name: ToolStart
          payload:
            type: "TOOL_CALL_START"
            toolCallId: "call-abc123"
            toolCallName: "search_regulations"
            toolDescription: "Ik ga hem nu aan de regulation agent geven"
            parentMessageId: "msg-abc123"
            timestamp: "2025-01-15T10:30:02Z"

    ToolCallArgsEvent:
      name: ToolCallArgsEvent
      title: Tool Call Args
      summary: Emitted to stream tool call arguments
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ToolCallArgsEvent'
      examples:
        - name: ToolArgs
          payload:
            type: "TOOL_CALL_ARGS"
            toolCallId: "call-abc123"
            delta: '{"query": "food safety", "limit": 10}'
            timestamp: "2025-01-15T10:30:02Z"

    ToolCallEndEvent:
      name: ToolCallEndEvent
      title: Tool Call End
      summary: Emitted when a tool call completes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ToolCallEndEvent'
      examples:
        - name: ToolSuccess
          payload:
            type: "TOOL_CALL_END"
            toolCallId: "call-abc123"
            result: "Found 5 relevant regulations"
            timestamp: "2025-01-15T10:30:03Z"
        - name: ToolError
          payload:
            type: "TOOL_CALL_END"
            toolCallId: "call-abc123"
            error: "Database connection timeout"
            timestamp: "2025-01-15T10:30:03Z"

    CustomEvent:
      name: CustomEvent
      title: Custom Event
      summary: Custom event for protocol extensions (HITL approval, errors)
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CustomEvent'
      examples:
        - name: ToolApprovalRequest
          summary: Request approval for high-risk operation
          payload:
            type: "CUSTOM"
            name: "agora:tool_approval_request"
            value:
              toolName: "generate_final_report"
              toolDescription: "Generates an official inspection report PDF"
              parameters:
                inspection_id: "INS-2024-001"
              reasoning: "User requested to finalize the inspection report"
              riskLevel: "high"
              approvalId: "appr-xyz789"
            timestamp: "2025-01-15T10:30:02Z"
        - name: ToolApprovalResponse
          summary: Client approval response
          payload:
            type: "CUSTOM"
            name: "agora:tool_approval_response"
            value:
              approvalId: "appr-xyz789"
              approved: true
              feedback: "Looks good, proceed"
        - name: Error
          summary: Server error
          payload:
            type: "CUSTOM"
            name: "agora:error"
            value:
              errorCode: "moderation_violation"
              message: "Content blocked"
              details:
                reason: "profanity"
            timestamp: "2025-01-15T10:30:02Z"
        - name: SpokenTextStart
          summary: Start of spoken text stream (TTS-optimized parallel to TEXT_MESSAGE)
          payload:
            type: "CUSTOM"
            name: "agora:spoken_text_start"
            value:
              messageId: "msg-abc123"
              role: "assistant"
            timestamp: "2025-01-15T10:30:02Z"
        - name: SpokenTextContent
          summary: Spoken text content chunk (TTS-optimized)
          payload:
            type: "CUSTOM"
            name: "agora:spoken_text_content"
            value:
              messageId: "msg-abc123"
              delta: "Based on the regulations, "
            timestamp: "2025-01-15T10:30:02Z"
        - name: SpokenTextEnd
          summary: End of spoken text stream
          payload:
            type: "CUSTOM"
            name: "agora:spoken_text_end"
            value:
              messageId: "msg-abc123"
            timestamp: "2025-01-15T10:30:04Z"

  schemas:
    RunAgentInput:
      type: object
      required: [threadId, messages, userId]
      properties:
        threadId:
          type: string
          description: Thread/session identifier
        runId:
          type: string
          description: Unique run identifier
        userId:
          type: string
          format: uuid
          description: |
            User ID that owns this session (AGORA extension to AG-UI protocol).
            Required for associating sessions with users.
          example: "550e8400-e29b-41d4-a716-446655440000"
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Input messages
        context:
          type: object
          additionalProperties: true
          description: Additional context

    Message:
      type: object
      required: [role, content]
      properties:
        role:
          type: string
          enum: [user, assistant, system, tool]
        content:
          type: string
        id:
          type: string
        toolCallId:
          type: string

    RunStartedEvent:
      type: object
      required: [type, threadId, runId]
      properties:
        type:
          type: string
          const: "RUN_STARTED"
        threadId:
          type: string
        runId:
          type: string
        timestamp:
          type: string
          format: date-time

    RunFinishedEvent:
      type: object
      required: [type, threadId, runId]
      properties:
        type:
          type: string
          const: "RUN_FINISHED"
        threadId:
          type: string
        runId:
          type: string
        timestamp:
          type: string
          format: date-time

    StepStartedEvent:
      type: object
      required: [type, stepName]
      properties:
        type:
          type: string
          const: "STEP_STARTED"
        stepName:
          type: string
        metadata:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time

    StepFinishedEvent:
      type: object
      required: [type, stepName]
      properties:
        type:
          type: string
          const: "STEP_FINISHED"
        stepName:
          type: string
        timestamp:
          type: string
          format: date-time

    TextMessageStartEvent:
      type: object
      required: [type, messageId, role]
      properties:
        type:
          type: string
          const: "TEXT_MESSAGE_START"
        messageId:
          type: string
        role:
          type: string
          enum: [user, assistant]
        timestamp:
          type: string
          format: date-time

    TextMessageContentEvent:
      type: object
      required: [type, messageId, delta]
      properties:
        type:
          type: string
          const: "TEXT_MESSAGE_CONTENT"
        messageId:
          type: string
        delta:
          type: string
        timestamp:
          type: string
          format: date-time

    TextMessageEndEvent:
      type: object
      required: [type, messageId]
      properties:
        type:
          type: string
          const: "TEXT_MESSAGE_END"
        messageId:
          type: string
        timestamp:
          type: string
          format: date-time

    ToolCallStartEvent:
      type: object
      required: [type, toolCallId, toolCallName]
      properties:
        type:
          type: string
          const: "TOOL_CALL_START"
        toolCallId:
          type: string
        toolCallName:
          type: string
        toolDescription:
          type: string
          nullable: true
          description: Human-readable spoken description of the tool action
        parentMessageId:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

    ToolCallArgsEvent:
      type: object
      required: [type, toolCallId, delta]
      properties:
        type:
          type: string
          const: "TOOL_CALL_ARGS"
        toolCallId:
          type: string
        delta:
          type: string
        timestamp:
          type: string
          format: date-time

    ToolCallEndEvent:
      type: object
      required: [type, toolCallId]
      properties:
        type:
          type: string
          const: "TOOL_CALL_END"
        toolCallId:
          type: string
        result:
          type: string
          nullable: true
        error:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

    CustomEvent:
      type: object
      required: [type, name, value]
      properties:
        type:
          type: string
          const: "CUSTOM"
        name:
          type: string
          description: Custom event name (e.g., agora:tool_approval_request)
        value:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
