# AGORA v1.0 Architecture & Tech Stack

## System Overview

AGORA is a multi-agent system for NVWA inspectors, built using an OpenAI-native backend (`server-openai`) utilizing the Agents SDK and MCP (Model Context Protocol) integration.

**Architecture Documentation**: See `c4/workspace-openai.dsl` (OpenAI Architecture).

## Architecture Pattern

**Multi-Agent Handoff Pattern**:
- **Entry Agent**: A generalist agent handles triage and common queries.
- **Specialist Agents**: Domain-specific agents (Regulation, History, Reporting) with scoped tools.
- **Handoffs**: Explicit control transfer between agents managed by the Agents SDK.
- **MCP Integration**: Tools are exposed via MCP servers and injected into agents.

## Tech Stack by Container

### 1. HAI (Human Agent Interface) - Frontend
**Technology**: React + TypeScript + WebSocket
**Purpose**: User interface for text interaction (Voice currently disabled).

**Stack**:
- React 18+ (UI framework)
- TypeScript
- WebSocket client (real-time communication)
- Zustand (State Management)
- shadcn/ui (Component Library)

### 2. Orchestrator - Backend Core (server-openai)
**Technology**: Python + OpenAI Agents SDK + FastAPI
**Purpose**: Central orchestration engine with session management.

**Stack**:
- Python 3.11+
- **openai-agents** (Agents SDK): Core multi-agent framework.
- **FastAPI**: API and WebSocket server.
- **SQLite**: Local session persistence (`sessions.db`).
- **MCP Client**: Model Context Protocol integration.
- **OpenTelemetry**: Instrumentation and audit logging.

### 3. Microservices (mcp-servers)
**Technology**: Python (FastMCP)
**Purpose**: Specialized tools and capabilities.

**Servers**:
- `regulation-analysis`: Regulatory search and compliance checking.
- `reporting`: Report generation and data extraction.
- `inspection-history`: Historical company data.
- `document-ingestion`: RAG pipeline.

### 4. Observability
**Technology**: Grafana + Prometheus + OpenTelemetry
**Purpose**: Monitoring, logging, and audit trails.

## Data Flow

```
Inspector (HAI)
  ↓ WebSocket (HAI Protocol)
Orchestrator (server-openai)
  ↓
HAIProtocolHandler
  ↓
Orchestrator Pipeline (Validation & Approval)
  ↓
AgentRunner (Agents SDK)
  ↓
SQLite Session Store (History)
  ↓
Current Agent (LLM)
  ↓
MCP Tool Registry
  ↓
MCP Server (e.g. Regulation)
```

## Project Folder Structure

```
agora/
├── HAI/                          # Frontend Application
│   ├── src/
│   │   ├── components/           # UI components
│   │   ├── lib/websocket/        # Protocol handling
│   │   └── stores/               # State management
│
├── server-openai/                # Backend Application
│   ├── src/agora_openai/
│   │   ├── core/                 # Agent definitions & Runner
│   │   ├── api/                  # Server & Protocol Handlers
│   │   ├── adapters/             # MCP & Audit adapters
│   │   └── pipelines/            # Orchestration logic
│   ├── sessions.db               # Local session storage
│
├── mcp-servers/                  # MCP Tool Servers
│   ├── regulation-analysis/
│   ├── reporting/
│   └── ...
│
├── c4/                           # Architecture diagrams
└── .cursor/rules/                # Development rules
```

## Key Architectural Decisions

### 1. OpenAI Agents SDK
- Native support for multi-agent patterns and handoffs.
- Simplified state management via `SQLiteSession`.
- Built-in streaming capabilities.

### 2. Model Context Protocol (MCP)
- Standardizes tool exposure.
- Decouples tool implementation from the agent logic.
- Allows independent scaling and deployment of capabilities.

### 3. Handoffs vs. Central Routing
- Agents explicitly hand off to specialists based on conversation flow.
- Reduces latency compared to a central "Router Agent" for every turn.
- Maintains context across agent transitions.

## Development Principles

1.  **Protocol-First**: HAI Protocol defines the contract between Frontend and Backend.
2.  **Scoped Capabilities**: Agents only see the MCP tools relevant to their domain.
3.  **Human-in-the-loop**: Critical tools require explicit user approval via the Orchestrator.
4.  **Auditability**: All actions and messages are logged via OpenTelemetry.
