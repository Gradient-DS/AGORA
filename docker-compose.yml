services:
  # === API Gateway ===
  api-gateway:
    build: ./api-gateway
    ports:
      - "8080:8000"
    environment:
      - GATEWAY_OPENAI_BACKEND_URL=http://server-openai:8000
      - GATEWAY_LANGGRAPH_BACKEND_URL=http://server-langgraph:8000
      - GATEWAY_MOCK_BACKEND_URL=http://mock-server:8000
      - GATEWAY_DEFAULT_BACKEND=${DEFAULT_BACKEND:-langgraph}
      - GATEWAY_API_KEYS=${API_KEYS:-}
      - GATEWAY_REQUIRE_AUTH=${REQUIRE_AUTH:-false}
      - GATEWAY_ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - GATEWAY_ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-pNInz6obpgDQGcFmaJgB}
    depends_on:
      server-langgraph:
        condition: service_healthy
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 10s
      timeout: 3s
      retries: 5

  # === Frontend ===
  # Note: VITE_* vars are baked in at build time (static React app)
  # Only non-sensitive config goes in build args
  # For ElevenLabs: either proxy through backend or use runtime config injection
  hai:
    build:
      context: ./HAI
      args:
        - VITE_WS_URL=ws://localhost:8080/ws
        - VITE_BACKEND=${VITE_BACKEND:-langgraph}
        - VITE_APP_NAME=${VITE_APP_NAME:-AGORA HAI}
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - agora-network

  # === Orchestrators ===
  server-openai:
    build: ./server-openai
    environment:
      - OPENAI_AGENTS_OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_AGENTS_MCP_SERVERS=regulation=http://regulation-analysis:8000,reporting=http://reporting:8000,history=http://inspection-history:8000
      - OPENAI_AGENTS_HOST=0.0.0.0
      - OPENAI_AGENTS_PORT=8000
    depends_on:
      regulation-analysis:
        condition: service_healthy
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 5

  server-langgraph:
    build: ./server-langgraph
    environment:
      - LANGGRAPH_OPENAI_API_KEY=${OPENAI_API_KEY}
      - LANGGRAPH_OPENAI_BASE_URL=${LANGGRAPH_OPENAI_BASE_URL:-https://api.openai.com/v1}
      - LANGGRAPH_OPENAI_MODEL=${LANGGRAPH_OPENAI_MODEL:-gpt-4o}
      - LANGGRAPH_MCP_SERVERS=regulation=http://regulation-analysis:8000,reporting=http://reporting:8000,history=http://inspection-history:8000
      # Optional: Faster model for spoken text generation
      - LANGGRAPH_SPOKEN_MODEL=${LANGGRAPH_SPOKEN_MODEL:-}
      - LANGGRAPH_SPOKEN_BASE_URL=${LANGGRAPH_SPOKEN_BASE_URL:-}
      - LANGGRAPH_SPOKEN_API_KEY=${LANGGRAPH_SPOKEN_API_KEY:-}
    volumes:
      - langgraph_sessions:/app/sessions
    depends_on:
      regulation-analysis:
        condition: service_healthy
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 5

  mock-server:
    build: ./docs/hai-contract
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 3s
      retries: 5

  # === MCP Servers ===
  regulation-analysis:
    build:
      context: ./mcp-servers
      dockerfile: ./regulation-analysis/Dockerfile
    environment:
      - MCP_WEAVIATE_URL=http://weaviate:8080
      - MCP_EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - MCP_EMBEDDING_DEVICE=cpu
      - MCP_OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  reporting:
    build: ./mcp-servers/reporting
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - reporting_storage:/app/storage
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 10s
      timeout: 3s
      retries: 5

  inspection-history:
    build: ./mcp-servers/inspection-history
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 10s
      timeout: 3s
      retries: 5

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.27.0
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      # Single-node Raft configuration to prevent cluster join issues
      - CLUSTER_HOSTNAME=weaviate
      - RAFT_BOOTSTRAP_EXPECT=1
      - RAFT_JOIN=weaviate:8300
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - agora-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 3s
      retries: 10

  # === One-off: Document Ingestion ===
  # Run with: docker compose run --rm document-ingestion
  # This populates Weaviate with regulation documents
  document-ingestion:
    build:
      context: ./mcp-servers
      dockerfile: ./document-ingestion/Dockerfile
    environment:
      - MCP_OPENAI_API_KEY=${OPENAI_API_KEY}
      - MCP_WEAVIATE_URL=http://weaviate:8080
      - MCP_EMBEDDING_PROVIDER=${MCP_EMBEDDING_PROVIDER:-openai}
      - MCP_INPUT_DIR=/app/input/SPEC Agent
    volumes:
      # Mount input PDFs (not baked into image for flexibility)
      - ./mcp-servers/input:/app/input:ro
      # Persist intermediate outputs for debugging
      - ./mcp-servers/document-ingestion/output:/app/output
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - agora-network
    profiles:
      - tools  # Only runs when explicitly requested

networks:
  agora-network:
    driver: bridge

volumes:
  weaviate_data:
  reporting_storage:
  langgraph_sessions:
